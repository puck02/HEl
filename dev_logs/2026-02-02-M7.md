## Milestone M7: 用药管理（无 OCR）

### 完成时间
2026-02-02

### 实现内容

#### 1. 数据层（Room + Entity）
- ✅ 创建 `MedEntity`：药品实体，包含药名、别名、备注、说明书摘要等字段
- ✅ 创建 `MedCourseEntity`：疗程实体，包含开始/结束日期、状态（active/paused/ended）、用药频率、剂量、时间提示
- ✅ 创建 `MedEventEntity`：用药事件实体，用于记录用户输入的自然语言变更（为 M8 做准备）
- ✅ 创建 `MedWithCourses`：关联查询实体
- ✅ 创建 `Converters`：LocalDate 类型转换器
- ✅ 创建 `MedicationDao`：用药管理 DAO，包含增删改查、疗程管理等方法

#### 2. 数据库更新
- ✅ 更新 `DailyReportDatabase` 版本从 5 到 6
- ✅ 添加三个新表：med、med_course、med_event
- ✅ 添加 TypeConverters 支持 LocalDate
- ✅ 暴露 `medicationDao()` 访问方法

#### 3. 业务层（Repository + ViewModel）
- ✅ 创建 `MedicationModels.kt`：定义 Med、MedCourse、CourseStatus 数据模型
- ✅ 创建 `MedicationRepository`：封装数据访问逻辑，提供药品和疗程管理方法
- ✅ 创建 `MedicationListViewModel`：管理用药列表状态，支持添加新药品

#### 4. UI 层（Compose）
- ✅ 创建 `MedicationListScreen`：用药列表页面，展示所有药品（正在服用/已停用）
- ✅ 创建 `AddMedicationDialog`：添加药品对话框，支持输入药名、频率、剂量、用药时间
- ✅ 创建 `MedicationDetailScreen`：药品详情页（占位实现，为后续扩展预留）
- ✅ 集成到 `MainActivity`：新增"用药"标签页，使用 Material Icons 的 Medication 图标

#### 5. 依赖注入更新
- ✅ 更新 `AppContainer` 接口，暴露 `database` 属性供 ViewModel 访问
- ✅ 重命名 `HElDairyApplication.container` 为 `appContainer`（统一命名规范）
- ✅ 更新所有 ViewModel Factory 中的引用（ThemeViewModel、SettingsViewModel、HomeDashboardViewModel、InsightsViewModel、DailyReportViewModel）

### 验证步骤
```bash
./gradlew build
```
- ✅ 编译通过（107 actionable tasks: 36 executed, 71 up-to-date）
- ✅ 无编译错误
- ⚠️ 有少量警告（MedicationRepository 中未使用的参数，MedicationDetailScreen 中未使用的 medId）

### 技术要点
- 使用 Room ForeignKey 实现药品与疗程的关联（CASCADE 删除）
- 使用 Flow 实现响应式数据流
- 疗程状态使用枚举 + 字符串转换（便于数据库存储和类型安全）
- 药品列表根据 hasActiveCourse 标志显示不同颜色（绿色=正在服用，灰色=已停用）

### 下一步（M8）
- 实现用药自然语言解析（DeepSeek）
- 实现变更草稿确认流程
- 支持开始/暂停/结束疗程操作
- JSON 校验与失败处理

### 已知问题
- MedicationRepository.updateCourseStatus 方法未完整实现（需要添加按 courseId 查询的方法）
- MedicationDetailScreen 当前为占位实现

### 参考
- 需求文档：`doc/requirements.md` 七、用药管理
- 里程碑定义：M7（用药管理，无 OCR）
